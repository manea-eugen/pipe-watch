# PipeWatch - Agent Context

## What is this?

A macOS menu bar app (SwiftUI) that monitors GitLab CI/CD pipelines and sends native notifications on status changes. The app lives entirely in the menu bar — no dock icon, no main window.

## Tech Stack

- **Language:** Swift 6.0 with strict concurrency
- **UI:** SwiftUI `MenuBarExtra` (`.window` style)
- **Minimum OS:** macOS 14.0
- **Signing:** Automatic (development team set in Xcode project)
- **Bundle ID:** `ai.pipewatch.app`
- **Project generation:** xcodegen (`project.yml`)

## Project Structure

```
PipeWatch/
├── Assets.xcassets/              # App icon (purple pipeline icon)
├── Info.plist                    # LSUIElement=true (menu bar only, no dock icon)
├── PipeWatch.entitlements
├── PipeWatch.xcodeproj/          # Generated by xcodegen from project.yml
├── project.yml                   # xcodegen spec
├── build.sh                      # Build + optional launch script
└── PipeWatch/
    ├── PipeWatchApp.swift              # @main entry, MenuBarExtra, AppDelegate
    ├── Models/
    │   ├── Pipeline.swift               # PipelineStatus enum, Pipeline, PipelineJob, TrackedPipeline
    │   └── GitLabProject.swift          # GitLabProject, GitLabUser
    ├── Services/
    │   ├── GitLabService.swift          # Actor-isolated GitLab REST API client
    │   ├── PipelineMonitor.swift        # Timer-based polling loop, state transitions, notifications
    │   └── NotificationManager.swift    # UNUserNotificationCenter wrapper
    ├── Stores/
    │   └── AppState.swift               # @Observable state: settings, runtime state, menu bar icon
    ├── Utilities/
    │   └── KeychainHelper.swift         # Keychain read/write for GitLab PAT
    └── Views/
        ├── PipelineListView.swift       # Main menu bar dropdown content
        ├── PipelineRowView.swift        # Individual pipeline row
        └── SettingsView.swift           # GitLab URL, token, preferences
```

## Architecture

### Data Flow

```
AppDelegate
  ├── AppState (@Observable, @MainActor)
  ├── NotificationManager
  └── PipelineMonitor
        └── GitLabService (actor)
```

- `AppDelegate` owns everything, wires up on launch.
- `PipelineMonitor` runs a `Timer` at the configured polling interval (default 30s, min 10s).
- Each poll cycle: fetch user → fetch projects (paginated, 24h activity window) → fetch pipelines per project (concurrently) → fetch jobs per pipeline (concurrently) → diff statuses → send notifications → update `AppState`.
- `AppState.trackedPipelines` drives the UI. Changes propagate via `@Observable`.
- `MenuBarExtra` label reads `appState.menuBarIcon` for the SF Symbol.

### Polling Cycle (PipelineMonitor.poll)

1. Fetch current user (cached after first call)
2. Fetch all member projects with activity in last 24h (paginated, 100/page)
3. Fetch up to 5 pipelines per project for the current user (updated in last 24h)
4. For failed branches, check if someone else pushed a fix (fetch latest pipeline by anyone)
5. Fetch jobs for ALL pipelines to detect: current running step, failed job + retry count, pending manual actions
6. Sort pipelines by newest first (highest ID)
7. Detect state transitions → send notifications (success, failed, canceled, manual)
8. Update AppState

### Key Design Decisions

- **`effectiveStatus`**: GitLab REST API reports pipelines as `success` even when manual jobs are pending. `TrackedPipeline.effectiveStatus` returns `.manual` when `pipeline.status == .success && manualJobs.isNotEmpty`.
- **Menu bar icon priority**: failed > running > pending > manual > success.
- **Pipelines are flat-listed** by creation date (newest first), not grouped by project.
- **Token stored in Keychain**, not UserDefaults.
- **No app sandbox** (`com.apple.security.app-sandbox = false`) — needed for unrestricted network and keychain access.

## GitLab API Endpoints Used

All via REST API v4 with `PRIVATE-TOKEN` header:

- `GET /api/v4/user` — current user
- `GET /api/v4/projects?membership=true&simple=true` — member projects (paginated)
- `GET /api/v4/projects/:id/pipelines?username=:user` — user's pipelines
- `GET /api/v4/projects/:id/pipelines/:pipeline_id/jobs` — pipeline jobs

## Build & Run

```bash
# Quick build + run
./build.sh Debug --run

# Or manually
xcodegen generate
xcodebuild -scheme PipeWatch -configuration Debug build -allowProvisioningUpdates
open ~/Library/Developer/Xcode/DerivedData/PipeWatch-*/Build/Products/Debug/PipeWatch.app

# Kill
pkill -f "PipeWatch"
```

The `-allowProvisioningUpdates` flag is needed for automatic provisioning profile creation.

## Logging

The app uses `NSLog` with `[PipelineMonitor]` prefix. To see logs when launching from terminal, run the binary directly:

```bash
~/Library/Developer/Xcode/DerivedData/PipeWatch-*/Build/Products/Debug/PipeWatch.app/Contents/MacOS/PipeWatch
```

## Common Issues

- **Notifications not appearing**: App must be code-signed (not ad-hoc) to appear in System Settings > Notifications. Currently signed with automatic provisioning.
- **Icon not showing in notifications**: `Assets.xcassets` must be in the Xcode project's Resources build phase. Managed via `project.yml` resources section.
- **Project not appearing in pipeline list**: The projects endpoint paginates at 100/page through all member projects with activity in the last 24h.
- **Pipeline shows "success" but has manual steps**: This is expected GitLab behavior. The app detects this by fetching jobs and checking for `manual` status, then overrides via `effectiveStatus`.
- **Token lost after fresh clone**: Keychain service ID is `ai.pipewatch.app`. Re-enter the token in settings on first launch.
